(()=>{"use strict";const e={formSelector:".popup__content",inputSelector:".popup__input",submitButtonSelector:".popup__save",inactiveButtonClass:"popup__save_type_disabled",inputErrorClass:"popup__input_type_error",errorClass:".popup__input-error"},t={cardTitle:".element__title",cardImageLink:".element__img",likeButton:".element__like",likeCount:".element__like-count",deleteButton:".element__delete"},s=".popup_type_description",r=document.querySelector(s),i=document.querySelector(".profile__edit-button"),n=r.querySelector(".popup__input_field_name"),o=document.querySelector(".profile__name"),l=r.querySelector(".popup__input_field_subtitle"),a=document.querySelector(".profile__subtitle"),_=(r.querySelector(".popup__close"),r.querySelector(".popup__content"),".popup_type_new-avatar"),c=document.querySelector(_),h=document.querySelector(".profile__avatar-btn"),u=document.querySelector(".profile__avatar-img"),p=(c.querySelector(".popup__input_field_link-avatar"),c.querySelector(".popup__close"),c.querySelector(".popup__content"),".popup_type_add-card"),d=document.querySelector(p),m=document.querySelector(".add-button"),k=(d.querySelector(".popup__close"),d.querySelector(".popup__input_field_place"),d.querySelector(".popup__input_field_link"),d.querySelector(".popup__content"),".popup_type_delete-photo"),S=(document.querySelector(k).querySelector(".popup__close"),".popup_type_image"),v=document.querySelector(S),C=(v.querySelector(".popup__image"),v.querySelector(".popup__image-caption"),v.querySelector(".popup__close_type_image"),document.querySelector(".elements__container"));class E{constructor({cardData:e,config:t,userId:s,template:r,handleCardClick:i,handleCardDelete:n,handleLikeClick:o}){this._name=e.name,this._link=e.link,this._description=e.description,this._likes=e.likes,this._cardId=e._id,this._userId=s,this._cardOwner=e.owner._id,this._cardSelector=r,this._cardTitleSelector=t.cardTitle,this._cardImgLinkSelector=t.cardImageLink,this._likeBtnSelector=t.likeButton,this._deleteBtnSelector=t.deleteButton,this._likeCount=t.likeCount,this._handleCardClick=i,this._handleCardDelete=n,this._handleLikeClick=o}_getTemplate(){return document.querySelector(this._cardSelector).content.children[0].cloneNode(!0)}_setEventListeners(){this._likeBtn.addEventListener("click",(()=>this._handleLikeClick())),this._deleteBtn.addEventListener("click",(()=>this._handleCardDelete())),this._image.addEventListener("click",(()=>{this._handleCardClick()}))}generateCard(){return this._element=this._getTemplate(),this._likeBtn=this._element.querySelector(this._likeBtnSelector),this._deleteBtn=this._element.querySelector(this._deleteBtnSelector),this._likeCountElement=this._element.querySelector(this._likeCount),this._image=this._element.querySelector(this._cardImgLinkSelector),this._element.querySelector(this._cardTitleSelector).textContent=this._name,this._likeCountElement.textContent=this._likes.length,this._image.src=this._link,this._image.alt=this._description,this._likeDirection(),this._delBtnDirection(),this._setEventListeners(),this._element}deleteCard(){this._element.closest(".element").remove()}_delBtnDirection(){this._userId!=this._cardOwner&&this._deleteBtn.remove()}addLikeCard(){this._likeBtn.classList.add("element__like_is-liked"),this.isLiked=!0}removeLikeCard(){this._likeBtn.classList.remove("element__like_is-liked"),this.isLiked=!1}_checkUserLike(){return this._likes.some((e=>e._id===this._userId))}_likeDirection(){this._checkUserLike()?this.addLikeCard():this.removeLikeCard()}updLikesCounter(e){this._likeCountElement.textContent=e.length}}class f{constructor(e,t){this._formElement=t,this._inputSelector=e.inputSelector,this._submitButtonSelector=e.submitButtonSelector,this._inactiveButtonClass=e.inactiveButtonClass,this._inputErrorClass=e.inputErrorClass,this._errorClass=e.errorClass,this._formInputs=[...this._formElement.querySelectorAll(this._inputSelector)],this._errors=[...this._formElement.querySelectorAll(this._errorClass)],this._formButton=this._formElement.querySelector(this._submitButtonSelector)}_setEveentListeners(){this._formInputs.forEach((e=>{e.addEventListener("input",(()=>{this._checkFormValid(e),this._toggleStyleSubmitBtn()}))}))}clearErrors(){this._formInputs.forEach((e=>{const t=this._formElement.querySelector(`#${e.id}-error`);this._hideInputErrors(e,t)})),this._disableSubmitBtn()}_showInputErrors(e,t){t.textContent=e.validationMessage,e.classList.add(this._inputErrorClass)}_hideInputErrors(e,t){t.textContent="",e.classList.remove(this._inputErrorClass)}_checkFormValid(e){const t=this._formElement.querySelector(`#${e.id}-error`);e.validity.valid?this._hideInputErrors(e,t):this._showInputErrors(e,t)}_enableSubmitBtn(){this._formButton.classList.remove(this._inactiveButtonClass),this._formButton.disabled=!1}_disableSubmitBtn(){this._formButton.classList.add(this._inactiveButtonClass),this._formButton.disabled="disabled"}_toggleStyleSubmitBtn(){this._formInputs.every((e=>e.validity.valid))?this._enableSubmitBtn():this._disableSubmitBtn()}enableValidation(){this._setEveentListeners()}}class y{constructor(e){this._popup=document.querySelector(e),this._popupCloseBtn=this._popup.querySelector(".popup__close"),this._handleEscClose=this._handleEscClose.bind(this)}open(){this._popup.classList.add("popup_is-opened"),document.addEventListener("keydown",this._handleEscClose)}close(){this._popup.classList.remove("popup_is-opened"),document.removeEventListener("keydown",this._handleEscClose)}_handleEscClose(e){"Escape"===e.key&&this.close()}setEventListeners(){this._popupCloseBtn.addEventListener("click",(()=>{this.close()})),this._popup.addEventListener("mousedown",(e=>{e.target===e.currentTarget&&this.close()}))}}class b extends y{constructor(e,t){super(e),this._form=this._popup.querySelector(".popup__content"),this._submitForm=t,this._inputFields=this._popup.querySelectorAll(".popup__input"),this._submitBtn=this._popup.querySelector(".popup__save")}_getInputValues(){return this._inputValues={},this._inputFields.forEach((e=>{this._inputValues[e.name]=e.value})),this._inputValues}setSubmitBtnText(e){this._submitBtn.textContent=e}setEventListeners(){super.setEventListeners(),this._popup.addEventListener("submit",(e=>{e.preventDefault(),this._submitForm(this._getInputValues())}))}close(){super.close(),this._form.reset()}}const L=new class{constructor({serverUrl:e,headers:t}){this._serverUrl=e,this._headers=t}_checkResponse(e){return e.ok?e.json():Promise.reject(`${e.status} ${e.statusText}`)}getCards(){return fetch(`${this._serverUrl}/cards`,{method:"GET",headers:this._headers}).then(this._checkResponse)}getUserInfo(){return fetch(`${this._serverUrl}/users/me`,{method:"GET",headers:this._headers}).then(this._checkResponse)}getAllData(){return Promise.all([this.getCards(),this.getUserInfo()])}createCard(e){return fetch(`${this._serverUrl}/cards`,{method:"POST",headers:this._headers,body:JSON.stringify({name:e.name,link:e.link})}).then(this._checkResponse)}setUserInfo(e){return fetch(`${this._serverUrl}/users/me`,{method:"PATCH",headers:this._headers,body:JSON.stringify({name:e.name,about:e.about})}).then(this._checkResponse)}setUserAvatar(e){return fetch(`${this._serverUrl}/users/me/avatar`,{method:"PATCH",headers:this._headers,body:JSON.stringify({avatar:e.avatar})}).then(this._checkResponse)}addLike(e){return fetch(`${this._serverUrl}/cards/${e}/likes`,{method:"PUT",headers:this._headers}).then(this._checkResponse)}removeLike(e){return fetch(`${this._serverUrl}/cards/${e}/likes`,{method:"DELETE",headers:this._headers}).then(this._checkResponse)}deleteCard(e){return fetch(`${this._serverUrl}/cards/${e}`,{method:"DELETE",headers:this._headers}).then(this._checkResponse)}}({serverUrl:"https://mesto.nomoreparties.co/v1/cohort-59",headers:{authorization:"015f9389-f767-4004-b14e-b18f050be44c","Content-Type":"application/json"}}),g=new class{constructor(e,t){this._renderer=e,this._container=t}renderItems(e){e.forEach((e=>{const t=this._renderer(e);this.addItem(t,"append")}))}addItem(e,t){"append"===t?this._container.append(e):this._container.prepend(e)}}(A,C),B=new class{constructor(e,t,s){this._profileNameElement=e,this._profileSubtitleElement=t,this._avatarElement=s}setUserInfo({name:e,about:t,userId:s}){this._profileNameElement.textContent=e,this._profileSubtitleElement.textContent=t,this._profileId=s}getUserInfo(){return{name:this._profileNameElement.textContent,about:this._profileSubtitleElement.textContent}}getUserId(){return this._profileId}setUserAvatar({avatar:e}){this._avatarElement.src=e}}(o,a,u),q=new class extends y{constructor(e){super(e),this._popupImage=this._popup.querySelector(".popup__image"),this._popupTitle=this._popup.querySelector(".popup__image-caption")}open(e,t,s){this._popupImage.src=t,this._popupImage.alt=s,this._popupTitle.textContent=e,super.open()}}(S),I=new b(p,(e=>{I.setSubmitBtnText("Сохранение..."),L.createCard(e).then((e=>{g.addItem(A(e),"prepend"),I.close()})).catch((e=>console.log(e))).finally((()=>{I.setSubmitBtnText("Создать")}))})),U=new b(s,(e=>{U.setSubmitBtnText("Сохранение..."),L.setUserInfo(e).then((e=>{B.setUserInfo(e),U.close()})).catch((e=>console.log(e))).finally((()=>{U.setSubmitBtnText("Сохранить")}))})),T=new b(_,(e=>{T.setSubmitBtnText("Сохранение..."),L.setUserAvatar(e).then((e=>{B.setUserAvatar(e),T.close()})).catch((e=>console.log(e))).finally((()=>{T.setSubmitBtnText("Сохранить")}))})),x=new class extends y{constructor(e){super(e),this._form=this._popup.querySelector(".popup__content"),this._submitBtn=this._popup.querySelector(".popup__save")}updateSubmit(e){this._handleSubmit=e}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(e=>{e.preventDefault(),this._handleSubmit()}))}setSubmitBtnText(e){this._submitBtn.textContent=e}}(k),w=new f(e,r),D=new f(e,d),$=new f(e,c);function A(e){"description"in e||(e.description=`На фото - ${e.name}`);const s=new E({cardData:e,config:t,userId:B.getUserId(),template:"#card-template",handleCardClick:()=>{q.open(e.name,e.link,e.description)},handleCardDelete:()=>{x.open(),x.updateSubmit((()=>{x.setSubmitBtnText("Удаление..."),L.deleteCard(e._id).then((()=>{s.deleteCard(),x.close()})).catch((e=>console.log(e))).finally((()=>{x.setSubmitBtnText("Да")}))}))},handleLikeClick:()=>{s.isLiked?L.removeLike(e._id).then((e=>{s.removeLikeCard(),s.updLikesCounter(e.likes)})).catch((e=>console.log(e))):L.addLike(e._id).then((e=>{s.addLikeCard(),s.updLikesCounter(e.likes)})).catch((e=>console.log(e)))}});return s.generateCard()}L.getAllData().then((e=>{const[t,s]=e;B.setUserInfo({name:s.name,about:s.about,userId:s._id}),B.setUserAvatar({avatar:s.avatar}),g.renderItems(t)})).catch((e=>console.error(e))),w.enableValidation(),D.enableValidation(),$.enableValidation(),I.setEventListeners(),U.setEventListeners(),q.setEventListeners(),T.setEventListeners(),x.setEventListeners(),i.addEventListener("click",(()=>{const e=B.getUserInfo();n.value=e.name,l.value=e.about,w.clearErrors(),U.open()})),m.addEventListener("click",(()=>{D.clearErrors(),I.open()})),h.addEventListener("click",(()=>{$.clearErrors(),T.open()}))})();